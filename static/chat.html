<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nurse Florence - Medical Information Assistant</title>
    <!-- Cache busting and force refresh -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f7f7f8;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding: 0 1rem;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 85%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: #667eea;
            color: white;
        }

        .assistant .message-avatar {
            background: #4CAF50;
            color: white;
        }

        .message-content {
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            line-height: 1.5;
        }

        .user .message-content {
            background: #667eea;
            color: white;
        }

        .input-container {
            padding: 1rem 0;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 22px;
            font-size: 1rem;
            resize: none;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: #667eea;
        }

        .send-button {
            width: 44px;
            height: 44px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            background: #5a6fd8;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
        }

        .loading-dots {
            display: flex;
            gap: 0.25rem;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: loading 1.4s infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes loading {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .disclaimer {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.9rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè• AI Nurse Florence</h1>
        <p>Healthcare AI Assistant - Real Medical Information from NIH Sources</p>
    </div>

    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="message assistant">
                <div class="message-avatar">F</div>
                <div class="message-content">
                    Hello! I'm AI Nurse Florence, your educational healthcare assistant. I can provide comprehensive medical information about diseases, conditions, and medical topics using REAL DATA from MyDisease.info, NIH, and MedlinePlus resources. No more demo responses! What would you like to learn about?
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    class="input-field" 
                    placeholder="Ask about a medical condition or disease..."
                    rows="1"
                ></textarea>
                <button id="sendButton" class="send-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,22 11,13 2,9"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send message on Enter (but allow Shift+Enter for new lines)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);

        function addMessage(content, isUser = false, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'U' : 'F';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isLoading) {
                contentDiv.innerHTML = `
                    <div class="loading">
                        <span>Thinking</span>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                `;
            } else {
                contentDiv.innerHTML = content;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return contentDiv; // Return for loading message updates
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Disable send button
            sendButton.disabled = true;
            
            // Add loading message
            const loadingContent = addMessage('', false, true);
            
            try {
                const response = await fetch(`/api/v1/disease?q=${encodeURIComponent(message)}&t=${Date.now()}&v=4`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data); // Debug logging
                
                // Remove loading message
                loadingContent.parentElement.remove();
                
                // Add AI response
                if (data.status === 'ok') {
                    // Create a comprehensive response using the actual disease data
                    let responseText = `üè• <strong>AI Nurse Florence - ${data.name || data.query}</strong><br><br>`;
                    responseText += `<em>${data.banner}</em><br><br>`;
                    
                    if (data.summary) {
                        responseText += `<strong>Information:</strong><br>${data.summary}<br><br>`;
                    }
                    
                    if (data.references && data.references.length > 0) {
                        responseText += `<strong>References:</strong><br>`;
                        data.references.forEach((ref, index) => {
                            responseText += `${index + 1}. <a href="${ref.url}" target="_blank">${ref.title}</a> - ${ref.source}<br>`;
                        });
                    }
                    
                    // Use innerHTML directly instead of replacing newlines
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message assistant';
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'message-avatar';
                    avatar.textContent = 'F';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    contentDiv.innerHTML = responseText;
                    
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(contentDiv);
                    messagesContainer.appendChild(messageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else {
                    addMessage('I apologize, but I encountered an issue processing your request. Please try again.', false);
                }
                
            } catch (error) {
                console.error('Error:', error);
                
                // Remove loading message
                loadingContent.parentElement.remove();
                
                // Add error message
                addMessage(`I'm sorry, I encountered a connection error: ${error.message}. Please check if the API is running and try again.`, false);
            }
            
            // Re-enable send button
            sendButton.disabled = false;
            messageInput.focus();
        }
    </script>
</body>
</html>
