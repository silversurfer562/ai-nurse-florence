<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBAR Report Wizard - AI Nurse Florence</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/wizardPersistence.js"></script>
    <script src="/static/js/careSettings.js"></script>
    <style>
        .wizard-container {
            max-width: 4xl;
            margin: 0 auto;
        }
        .step-indicator {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .step-indicator.active {
            background: #6366f1;
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        .step-indicator.pending {
            background: #e5e7eb;
            color: #6b7280;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .epic-header {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
        }
        .form-field {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #6366f1;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .message-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
        }
        .message-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #ef4444;
        }
        .message-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connection-status.connected {
            background-color: #10b981;
            box-shadow: 0 0 8px #10b981;
        }
        .connection-status.disconnected {
            background-color: #ef4444;
        }
        .connection-status.testing {
            background-color: #f59e0b;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="epic-header text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center space-x-3 hover:opacity-80 transition-opacity">
                        <i class="fas fa-hospital text-2xl"></i>
                        <div>
                            <h1 class="text-xl font-bold">AI Nurse Florence</h1>
                            <p class="text-indigo-200 text-sm">SBAR Report Wizard</p>
                        </div>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="connection-status disconnected" id="connectionStatus"></span>
                        <span class="text-sm" id="statusIndicator">Not Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Information Banner -->
    <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-indigo-400 mr-3"></i>
                <div>
                    <h3 class="text-sm font-medium text-indigo-800">SBAR Report Wizard</h3>
                    <p class="text-sm text-indigo-700">Document patient status using SBAR communication framework</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="wizard-container bg-white rounded-lg shadow-xl">
            <!-- Progress Bar -->
            <div class="bg-gray-200 h-2 rounded-t-lg overflow-hidden">
                <div id="progressBar" class="progress-bar bg-indigo-600 h-full" style="width: 0%"></div>
            </div>

            <!-- Wizard Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" id="wizardTitle">SBAR Report Wizard</h2>
                        <p class="text-gray-600 mt-1" id="wizardDescription">Document patient status using SBAR communication framework</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Step <span id="currentStepNum">1</span> of 4</div>
                        <div class="text-lg font-semibold text-indigo-600" id="progressPercent">0%</div>
                    </div>
                </div>

                <!-- Step Indicators -->
                <div class="flex justify-between items-center mt-6">
                    <div class="step-indicator pending rounded-full w-10 h-10 flex items-center justify-center font-semibold" data-step="1" onclick="navigateToStep(1)">
                        <span>1</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                    <div class="step-indicator pending rounded-full w-10 h-10 flex items-center justify-center font-semibold" data-step="2" onclick="navigateToStep(2)">
                        <span>2</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                    <div class="step-indicator pending rounded-full w-10 h-10 flex items-center justify-center font-semibold" data-step="3" onclick="navigateToStep(3)">
                        <span>3</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                    <div class="step-indicator pending rounded-full w-10 h-10 flex items-center justify-center font-semibold" data-step="4" onclick="navigateToStep(4)">
                        <span>4</span>
                    </div>
                </div>

                <!-- Step Labels -->
                <div class="flex justify-between items-center mt-2 text-xs text-gray-600">
                    <div class="text-center w-10">Situation</div>
                    <div class="flex-1"></div>
                    <div class="text-center w-10">Background</div>
                    <div class="flex-1"></div>
                    <div class="text-center w-10">Assessment</div>
                    <div class="flex-1"></div>
                    <div class="text-center w-10">Recommendation</div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="px-6 pt-4"></div>

            <!-- Step 1: Situation -->
            <div id="step1" class="step-content p-6">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-900 mb-4">
                        <i class="fas fa-stethoscope text-indigo-600 mr-2"></i>
                        Current Situation
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Describe the patient's current condition and what brought them to your attention</p>

                    <!-- Patient ID -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Patient MRN (optional)</label>
                        <input type="text" id="patientMrn" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="12345678">
                    </div>

                    <!-- Vital Signs -->
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">BP</label>
                            <input type="text" id="bloodPressure" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="120/80">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">HR</label>
                            <input type="text" id="heartRate" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="75">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Temp (Â°F)</label>
                            <input type="text" id="temperature" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="98.6">
                        </div>
                    </div>

                    <!-- Chief Complaint -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chief Complaint / Situation</label>
                        <textarea id="chiefComplaint" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="What is the patient's current condition? What brought them to your attention?"></textarea>
                    </div>

                    <!-- Quick-fill templates -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick-Fill Common Scenarios</label>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button" onclick="fillChestPain()" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm hover:bg-indigo-200">
                                <i class="fas fa-heart-pulse mr-1"></i> Chest Pain
                            </button>
                            <button type="button" onclick="fillFall()" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm hover:bg-indigo-200">
                                <i class="fas fa-person-falling mr-1"></i> Fall
                            </button>
                            <button type="button" onclick="fillShortness()" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm hover:bg-indigo-200">
                                <i class="fas fa-lungs mr-1"></i> Shortness of Breath
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Background -->
            <div id="step2" class="step-content p-6">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-900 mb-4">
                        <i class="fas fa-file-medical text-indigo-600 mr-2"></i>
                        Patient Background
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Relevant medical history, current medications, and allergies</p>

                    <!-- Medical History -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Relevant Medical History</label>
                        <textarea id="medicalHistory" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="e.g., CHF, COPD, diabetes..."></textarea>
                    </div>

                    <!-- Current Medications -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Medications</label>
                        <textarea id="medications" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="List current medications..."></textarea>
                    </div>

                    <!-- Allergies -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Allergies</label>
                        <input type="text" id="allergies" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="e.g., Penicillin, Codeine">
                    </div>

                    <!-- Recent Events -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recent Events / Procedures</label>
                        <textarea id="recentEvents" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="What has happened recently that is relevant?"></textarea>
                    </div>
                </div>
            </div>

            <!-- Step 3: Assessment -->
            <div id="step3" class="step-content p-6">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-900 mb-4">
                        <i class="fas fa-stethoscope text-indigo-600 mr-2"></i>
                        Clinical Assessment
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Your professional nursing judgment about the situation</p>

                    <!-- Assessment -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assessment / Clinical Judgment</label>
                        <textarea id="assessment" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="What do you think is going on? What are your concerns?"></textarea>
                    </div>

                    <!-- Severity Level -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Severity Level</label>
                        <div class="flex gap-3">
                            <label class="flex items-center px-4 py-2 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-green-400">
                                <input type="radio" name="severity" value="routine" class="mr-2">
                                <span class="text-sm">Routine</span>
                            </label>
                            <label class="flex items-center px-4 py-2 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-yellow-400">
                                <input type="radio" name="severity" value="concerning" class="mr-2">
                                <span class="text-sm">Concerning</span>
                            </label>
                            <label class="flex items-center px-4 py-2 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-red-400">
                                <input type="radio" name="severity" value="urgent" class="mr-2">
                                <span class="text-sm">Urgent</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Recommendation -->
            <div id="step4" class="step-content p-6">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-900 mb-4">
                        <i class="fas fa-clipboard-check text-indigo-600 mr-2"></i>
                        Recommendations & Actions
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">What do you recommend? What should be done?</p>

                    <!-- Recommendations -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recommendations</label>
                        <textarea id="recommendations" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="What interventions or actions do you recommend?"></textarea>
                    </div>

                    <!-- Urgency -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Time Frame</label>
                        <select id="timeFrame" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="immediate">Immediate attention needed</option>
                            <option value="within_hour">Within 1 hour</option>
                            <option value="within_shift">Within this shift</option>
                            <option value="routine">Routine follow-up</option>
                        </select>
                    </div>

                    <!-- Review Summary -->
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mt-6">
                        <h4 class="font-semibold text-indigo-900 mb-2">SBAR Report Summary</h4>
                        <div id="sbarPreview" class="text-sm text-indigo-800">
                            <p class="mb-1"><strong>S:</strong> <span id="previewSituation">--</span></p>
                            <p class="mb-1"><strong>B:</strong> <span id="previewBackground">--</span></p>
                            <p class="mb-1"><strong>A:</strong> <span id="previewAssessment">--</span></p>
                            <p><strong>R:</strong> <span id="previewRecommendation">--</span></p>
                        </div>
                    </div>

                    <div class="mt-4 flex gap-3">
                        <button type="button" onclick="printSBAR()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-print mr-2"></i> Print Report
                        </button>
                        <button type="button" onclick="copySBAR()" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-copy mr-2"></i> Copy to Clipboard
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="border-t border-gray-200 p-6 flex justify-between">
                <button id="backBtn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" onclick="navigateBack()" disabled>
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <button id="nextBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" onclick="navigateNext()">
                    Next<i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button id="finishBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors hidden" onclick="finishWizard()">
                    <i class="fas fa-check mr-2"></i>Save SBAR Report
                </button>
            </div>
        </div>
    </main>

    <script>
        // Wizard State
        let wizardState = {
            current_step: 1,
            completed_steps: [],
            total_steps: 4,
            session_id: 'default',
            data: {}
        };

        // API Base URL
        const API_BASE = '/api/v1/wizard';

        // Initialize wizard on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('SBAR Report Wizard loaded');
            await startWizard();
        });

        // Start wizard
        async function startWizard() {
            try {
                const response = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reset_existing: false })
                });

                if (!response.ok) {
                    throw new Error(`Failed to start wizard: ${response.statusText}`);
                }

                const data = await response.json();
                updateWizardUI(data);

                // Populate sandbox defaults
                populateSandboxDefaults();
            } catch (error) {
                console.log('Wizard initialization: using fallback mode');
                // Silent fallback - don't show error messages for demo
            }
        }

        // Navigate to specific step
        async function navigateToStep(stepNum) {
            // Only allow navigation to completed steps or current step + 1
            if (stepNum > wizardState.current_step + 1 && !wizardState.completed_steps.includes(stepNum)) {
                showMessage('warning', 'Please complete the current step before proceeding.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/navigate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'jump', target_step: stepNum })
                });

                if (!response.ok) {
                    throw new Error(`Navigation failed: ${response.statusText}`);
                }

                const data = await response.json();
                updateWizardUI(data);
            } catch (error) {
                console.error('Navigation error:', error);
                showMessage('error', `Navigation failed: ${error.message}`);
            }
        }

        // Navigate back
        async function navigateBack() {
            if (wizardState.current_step <= 1) return;

            try {
                const response = await fetch(`${API_BASE}/navigate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'back' })
                });

                if (!response.ok) {
                    throw new Error(`Navigation failed: ${response.statusText}`);
                }

                const data = await response.json();
                updateWizardUI(data);

                // Populate step-specific content after navigation
                handleStepSpecificLogic(data);
            } catch (error) {
                console.error('Navigation error:', error);
                showMessage('error', `Navigation failed: ${error.message}`);
            }
        }

        // Navigate next - CLIENT-SIDE MODE FOR DEMO
        function navigateNext() {
            // Validate current step before proceeding
            if (!validateCurrentStep()) {
                return;
            }

            // Collect and save current step data
            const stepData = collectCurrentStepData();
            Object.assign(wizardState.data, stepData);

            // Mark current step as completed
            if (!wizardState.completed_steps.includes(wizardState.current_step)) {
                wizardState.completed_steps.push(wizardState.current_step);
            }

            // Advance to next step
            wizardState.current_step = Math.min(wizardState.current_step + 1, 4);

            // Update UI
            updateWizardUI({
                current_step: wizardState.current_step,
                completed_steps: wizardState.completed_steps,
                total_steps: 4,
                progress_percent: Math.floor((wizardState.current_step / 4) * 100),
                step_name: 'SBAR Report Wizard',
                step_description: 'Document patient status using SBAR communication framework',
                can_proceed: true,
                errors: [],
                warnings: [],
                messages: [],
                state_data: wizardState.data
            });

            handleStepSpecificLogic({state_data: wizardState.data});
        }

        // Handle step-specific UI population
        function handleStepSpecificLogic(data) {
            if (wizardState.current_step === 4) {
                // Update SBAR preview on step 4
                setTimeout(() => {
                    updateSBARPreview();
                }, 100);
            }
        }

        // Finish wizard
        async function finishWizard() {
            try {
                const response = await fetch(`${API_BASE}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`Wizard completion failed: ${response.statusText}`);
                }

                const data = await response.json();
                updateWizardUI(data);

                showMessage('success', 'SBAR report saved successfully!');
                updateConnectionStatus('connected', 'Report Saved');
            } catch (error) {
                console.error('Wizard completion error:', error);
                showMessage('error', `Failed to complete wizard: ${error.message}`);
            }
        }

        // Collect current step data
        function collectCurrentStepData() {
            const stepData = {};

            switch (wizardState.current_step) {
                case 1: // Situation
                    stepData.patient_mrn = document.getElementById('patientMrn')?.value || '';
                    stepData.blood_pressure = document.getElementById('bloodPressure')?.value || '';
                    stepData.heart_rate = document.getElementById('heartRate')?.value || '';
                    stepData.temperature = document.getElementById('temperature')?.value || '';
                    stepData.chief_complaint = document.getElementById('chiefComplaint')?.value || '';
                    break;

                case 2: // Background
                    stepData.medical_history = document.getElementById('medicalHistory')?.value || '';
                    stepData.medications = document.getElementById('medications')?.value || '';
                    stepData.allergies = document.getElementById('allergies')?.value || '';
                    stepData.recent_events = document.getElementById('recentEvents')?.value || '';
                    break;

                case 3: // Assessment
                    stepData.assessment = document.getElementById('assessment')?.value || '';
                    stepData.severity = document.querySelector('input[name="severity"]:checked')?.value || 'routine';
                    break;

                case 4: // Recommendation
                    stepData.recommendations = document.getElementById('recommendations')?.value || '';
                    stepData.time_frame = document.getElementById('timeFrame')?.value || 'routine';
                    // Update preview
                    updateSBARPreview();
                    break;
            }

            return stepData;
        }

        // Validate current step - DISABLED FOR DEMO
        function validateCurrentStep() {
            // No validation - allow free navigation for demo purposes
            return true;
        }

        // Update wizard UI based on state
        function updateWizardUI(data) {
            wizardState = {
                current_step: data.current_step,
                completed_steps: data.completed_steps || [],
                total_steps: data.total_steps || 4,
                data: data.state_data || {}
            };

            // Update progress
            const progressPercent = data.progress_percent || 0;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressPercent').textContent = `${progressPercent}%`;
            document.getElementById('currentStepNum').textContent = data.current_step;

            // Update step indicators
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                const stepNum = index + 1;
                indicator.classList.remove('active', 'completed', 'pending');

                if (stepNum === data.current_step) {
                    indicator.classList.add('active');
                } else if (data.completed_steps.includes(stepNum)) {
                    indicator.classList.add('completed');
                } else {
                    indicator.classList.add('pending');
                }
            });

            // Show/hide step content
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === data.current_step) {
                    content.classList.add('active');
                }
            });

            // Update navigation buttons
            const backBtn = document.getElementById('backBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');

            backBtn.disabled = data.current_step === 1;

            if (data.current_step === 4) {
                nextBtn.classList.add('hidden');
                finishBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                finishBtn.classList.add('hidden');
                nextBtn.disabled = !data.can_proceed;
            }

            // Update wizard title and description
            document.getElementById('wizardTitle').textContent = data.step_name || 'SBAR Report Wizard';
            document.getElementById('wizardDescription').textContent = data.step_description || '';

            // Clear any previous messages
            document.getElementById('messagesArea').innerHTML = '';

            // Show simple status message if there are any errors/warnings - don't interrupt UX
            if ((data.errors && data.errors.length > 0) || (data.warnings && data.warnings.length > 0)) {
                const statusBar = document.createElement('div');
                statusBar.className = 'text-sm text-gray-600 bg-gray-50 px-4 py-2 rounded border-l-4 border-gray-400';
                statusBar.innerHTML = `
                    <i class="fas fa-info-circle mr-2"></i>
                    <span>Due to connectivity issues, you'll need to enter configuration details manually.</span>
                `;
                document.getElementById('messagesArea').appendChild(statusBar);
            }
        }

        // Show friendly info banner for manual entry
        function showInfoBanner() {
            const messagesArea = document.getElementById('messagesArea');

            // Only show once
            if (document.getElementById('manualEntryBanner')) return;

            const banner = document.createElement('div');
            banner.id = 'manualEntryBanner';
            banner.className = 'bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg mb-4';
            banner.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-600 mr-3 mt-0.5"></i>
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-blue-900 mb-1">Manual Entry Mode</p>
                        <p class="text-sm text-blue-800">Unable to auto-detect configuration. You'll need to enter your Epic FHIR credentials manually in the next steps. This is normal if you're setting up for the first time or don't have connectivity to Epic services yet.</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-blue-600 hover:text-blue-800 flex-shrink-0">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            messagesArea.appendChild(banner);
        }

        // Show message (improved with collapsible details)
        function showMessage(type, text) {
            const messagesArea = document.getElementById('messagesArea');
            const messageClass = `message-${type}`;
            const icon = type === 'error' ? 'fa-times-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-check-circle';

            // Simplify long technical error messages
            let displayText = text;
            let detailsText = '';
            let isCollapsible = false;

            // Check if this is a long configuration error
            if (text.includes('validation errors for Settings') || text.length > 200) {
                isCollapsible = true;

                // Extract summary
                if (text.includes('Prerequisites missing')) {
                    displayText = 'Configuration check: Some prerequisites are missing (click to see details)';
                    detailsText = text;
                } else if (text.includes('validation errors')) {
                    displayText = 'Configuration validation issues detected (click to see details)';
                    detailsText = text;
                } else if (text.length > 200) {
                    displayText = text.substring(0, 150) + '... (click to see full message)';
                    detailsText = text;
                }
            }

            const messageId = `msg-${Date.now()}`;
            const messageDiv = document.createElement('div');
            messageDiv.className = `${messageClass} p-4 rounded-lg mb-2`;
            messageDiv.innerHTML = `
                <div class="flex items-start">
                    <i class="fas ${icon} mr-3 mt-0.5"></i>
                    <div class="flex-1">
                        <span class="cursor-pointer" onclick="toggleMessageDetails('${messageId}')">${displayText}</span>
                        ${isCollapsible ? `
                            <div id="${messageId}" class="hidden mt-2 p-3 bg-black bg-opacity-5 rounded text-xs font-mono whitespace-pre-wrap max-h-48 overflow-y-auto">
                                ${detailsText}
                            </div>
                        ` : ''}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-600 hover:text-gray-800 flex-shrink-0">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            messagesArea.appendChild(messageDiv);

            // Auto-remove success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => messageDiv.remove(), 5000);
            }
        }

        // Toggle message details
        function toggleMessageDetails(id) {
            const details = document.getElementById(id);
            if (details) {
                details.classList.toggle('hidden');
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(status, text) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusIndicator');

            statusIndicator.className = `connection-status ${status}`;
            statusText.textContent = text;
        }

        // Quick-fill templates
        function fillChestPain() {
            document.getElementById('chiefComplaint').value = "Patient reports chest pain, 7/10 severity, radiating to left arm. Diaphoretic, appears anxious.";
            document.getElementById('bloodPressure').value = "140/90";
            document.getElementById('heartRate').value = "98";
        }

        function fillFall() {
            document.getElementById('chiefComplaint').value = "Patient found on floor next to bed. States slipped when attempting to go to bathroom unassisted.";
        }

        function fillShortness() {
            document.getElementById('chiefComplaint').value = "Patient experiencing increased shortness of breath, O2 sat 88% on room air, using accessory muscles.";
            document.getElementById('heartRate').value = "110";
        }

        // Update SBAR preview
        function updateSBARPreview() {
            const chiefComplaint = document.getElementById('chiefComplaint')?.value || '--';
            const medicalHistory = document.getElementById('medicalHistory')?.value || '--';
            const assessment = document.getElementById('assessment')?.value || '--';
            const recommendations = document.getElementById('recommendations')?.value || '--';

            document.getElementById('previewSituation').textContent = chiefComplaint.substring(0, 100) + (chiefComplaint.length > 100 ? '...' : '');
            document.getElementById('previewBackground').textContent = medicalHistory.substring(0, 100) + (medicalHistory.length > 100 ? '...' : '');
            document.getElementById('previewAssessment').textContent = assessment.substring(0, 100) + (assessment.length > 100 ? '...' : '');
            document.getElementById('previewRecommendation').textContent = recommendations.substring(0, 100) + (recommendations.length > 100 ? '...' : '');
        }

        // Print SBAR
        function printSBAR() {
            window.print();
        }

        // Copy SBAR to clipboard
        function copySBAR() {
            const sbarText = `SBAR REPORT

S - SITUATION:
${document.getElementById('chiefComplaint')?.value || ''}

B - BACKGROUND:
Medical History: ${document.getElementById('medicalHistory')?.value || ''}
Medications: ${document.getElementById('medications')?.value || ''}
Allergies: ${document.getElementById('allergies')?.value || ''}

A - ASSESSMENT:
${document.getElementById('assessment')?.value || ''}
Severity: ${document.querySelector('input[name="severity"]:checked')?.value || 'Not specified'}

R - RECOMMENDATION:
${document.getElementById('recommendations')?.value || ''}
Time Frame: ${document.getElementById('timeFrame')?.value || 'Not specified'}`;

            navigator.clipboard.writeText(sbarText).then(() => {
                alert('SBAR report copied to clipboard!');
            });
        }

        // Remove unused Epic functions - placeholders kept for compatibility
        function displayConnectionTestResults(data) {
            // Not used in SBAR wizard
        }

        function retryConnection() {
            // Not used in SBAR wizard
        }

        function lookupPatient() {
            // Not used in SBAR wizard
        }

        function populateReviewContent() {
            // Not used in SBAR wizard - preview is inline on step 4
        }

        function populateCredentialsFromState(data) {
            // Not used in SBAR wizard
        }

        function toggleSandboxMode(isSandbox) {
            // Not used in SBAR wizard
        }

        function populateSandboxDefaults() {
            // Not used in SBAR wizard
        }

        function clearCredentialFields() {
            // Not used in SBAR wizard
        }

        function copyToClipboard(elementId) {
            // Not used in SBAR wizard
        }

        function togglePasswordVisibility(elementId) {
            // Not used in SBAR wizard
        }
    
        // ===== PERSISTENCE FUNCTIONS =====

        const WIZARD_ID = 'sbar-wizard';

        // Check for saved draft on page load
        window.addEventListener('DOMContentLoaded', () => {
            if (WizardPersistence.hasSavedDraft(WIZARD_ID)) {
                WizardPersistence.showResumeDraftModal(
                    WIZARD_ID,
                    () => resumeDraft(),
                    () => console.log('Starting fresh')
                );
            }
            // Initialize care setting framework
            CareSettings.init({
                showOnboardingIfNew: false,
                injectBadge: true,
                headerSelector: 'header'
            });

        });

        // Auto-save on next step
        const originalNextStep = nextStep;
        function nextStep() {
            autosaveDraft();
            originalNextStep();
        }

        // Auto-save draft
        function autosaveDraft() {
            const formData = {};
            const currentStepNum = parseInt(document.querySelector('.step.active')?.dataset.step || '1');

            // Collect data from all steps
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                const stepData = {};

                step.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.id) {
                        if (input.type === 'checkbox') {
                            stepData[input.id] = input.checked;
                        } else if (input.type === 'radio') {
                            if (input.checked) {
                                stepData[input.name] = input.value;
                            }
                        } else {
                            stepData[input.id] = input.value;
                        }
                    }
                });

                if (Object.keys(stepData).length > 0) {
                    formData[`step${stepNum}`] = stepData;
                }
            });

            WizardPersistence.saveWizardState(WIZARD_ID, currentStepNum, formData);

            // Show save button
            const saveBtn = document.getElementById('saveDraftBtn');
            if (saveBtn && currentStepNum > 1) {
                saveBtn.style.display = 'inline-block';
            }
        }

        // Manual save
        function saveDraft() {
            autosaveDraft();
            alert('Draft saved successfully!');
        }

        // Resume draft
        function resumeDraft() {
            const savedState = WizardPersistence.loadWizardState(WIZARD_ID);
            if (!savedState) return;

            // Restore to saved step
            const targetStep = savedState.currentStep;

            // Restore form data
            if (savedState.formData) {
                Object.keys(savedState.formData).forEach(stepKey => {
                    const stepData = savedState.formData[stepKey];
                    Object.keys(stepData).forEach(fieldId => {
                        const input = document.getElementById(fieldId);
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = stepData[fieldId];
                            } else if (input.type === 'radio') {
                                const radio = document.querySelector(`input[name="${fieldId}"][value="${stepData[fieldId]}"]`);
                                if (radio) radio.checked = true;
                            } else {
                                input.value = stepData[fieldId];
                            }
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                });
            }

            // Navigate to saved step
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active');
                if (i + 1 === targetStep) {
                    s.classList.add('active');
                }
                if (i + 1 < targetStep) {
                    document.querySelector(`[data-step="${i+1}"]`)?.classList.add('completed');
                }
            });

            currentStep = targetStep;
            updateProgress();

            const lastSave = WizardPersistence.getLastSaveTime(WIZARD_ID);
            alert(`Draft restored from ${lastSave}`);
        }

        // Clear draft on completion
        const originalCompleteWizard = window.completeWizard || function() {};
        window.completeWizard = function() {
            WizardPersistence.clearWizardState(WIZARD_ID);
            originalCompleteWizard();
        };

    </script>
</body>
</html>
