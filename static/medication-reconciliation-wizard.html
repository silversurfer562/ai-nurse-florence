<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Reconciliation Wizard - AI Nurse Florence</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/wizardPersistence.js"></script>
    <script src="/static/js/careSettings.js"></script>
    <style>
        .wizard-container {
            max-width: 4xl;
            margin: 0 auto;
        }
        .step-indicator {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .step-indicator.active {
            background: #6366f1;
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        .step-indicator.pending {
            background: #e5e7eb;
            color: #6b7280;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .epic-header {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
        }
        .form-field {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #6366f1;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .message-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
        }
        .message-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #ef4444;
        }
        .message-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connection-status.connected {
            background-color: #10b981;
            box-shadow: 0 0 8px #10b981;
        }
        .connection-status.disconnected {
            background-color: #ef4444;
        }
        .connection-status.testing {
            background-color: #f59e0b;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="epic-header text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center space-x-3 hover:opacity-80 transition-opacity">
                        <i class="fas fa-hospital text-2xl"></i>
                        <div>
                            <h1 class="text-xl font-bold">AI Nurse Florence</h1>
                            <p class="text-indigo-200 text-sm">Medication Reconciliation Wizard</p>
                        </div>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="connection-status disconnected" id="connectionStatus"></span>
                        <span class="text-sm" id="statusIndicator">Not Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Information Banner -->
    <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-indigo-400 mr-3"></i>
                <div>
                    <h3 class="text-sm font-medium text-indigo-800">Medication Reconciliation Wizard</h3>
                    <p class="text-sm text-indigo-700">Prevent medication errors during care transitions. Complete all steps to reconcile patient medications.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="wizard-container bg-white rounded-lg shadow-xl">
            <!-- Progress Bar -->
            <div class="bg-gray-200 h-2 rounded-t-lg overflow-hidden">
                <div id="progressBar" class="progress-bar bg-indigo-600 h-full" style="width: 0%"></div>
            </div>

            <!-- Wizard Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" id="wizardTitle">Epic Integration Setup</h2>
                        <p class="text-gray-600 mt-1" id="wizardDescription">Complete all steps to configure Epic FHIR integration</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Step <span id="currentStepNum">1</span> of 4</div>
                        <div class="text-lg font-semibold text-indigo-600" id="progressPercent">0%</div>
                    </div>
                </div>

                <!-- Step Indicators -->
                <div class="flex justify-between items-center mt-6">
                    <div class="step-indicator pending rounded-full w-10 h-10 flex items-center justify-center font-semibold" data-step="1" onclick="navigateToStep(1)">
                        <span>1</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                    <div class="step-indicator pending rounded-full w-10 h-10 flex items-center justify-center font-semibold" data-step="2" onclick="navigateToStep(2)">
                        <span>2</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                    <div class="step-indicator pending rounded-full w-10 h-10 flex items-center justify-center font-semibold" data-step="3" onclick="navigateToStep(3)">
                        <span>3</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                    <div class="step-indicator pending rounded-full w-10 h-10 flex items-center justify-center font-semibold" data-step="4" onclick="navigateToStep(4)">
                        <span>4</span>
                    </div>
                </div>

                <!-- Step Labels -->
                <div class="flex justify-between items-center mt-2 text-xs text-gray-600">
                    <div class="text-center w-10">Patient Info</div>
                    <div class="flex-1"></div>
                    <div class="text-center w-10">Home Meds</div>
                    <div class="flex-1"></div>
                    <div class="text-center w-10">Hospital Meds</div>
                    <div class="flex-1"></div>
                    <div class="text-center w-10">Reconciliation</div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="px-6 pt-4"></div>

            <!-- Step 1: Patient Information -->
            <div id="step1Content" class="step-content active p-6">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-900 mb-4">
                        <i class="fas fa-user-injured text-indigo-600 mr-2"></i>
                        Patient Information
                    </h3>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Patient MRN</label>
                            <input type="text" id="patientMrn" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="12345678">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Patient Name</label>
                            <input type="text" id="patientName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Last, First">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">DOB</label>
                            <input type="date" id="dob" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Weight (kg)</label>
                            <input type="number" id="weight" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="70">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Allergies</label>
                            <input type="text" id="allergies" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Penicillin">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Transition Type</label>
                        <select id="transitionType" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="admission">Admission</option>
                            <option value="transfer">Transfer</option>
                            <option value="discharge">Discharge</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 2: Home Medications -->
            <div id="step2Content" class="step-content p-6">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-900 mb-4">
                        <i class="fas fa-home text-indigo-600 mr-2"></i>
                        Home Medications
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Enter medications patient was taking at home before admission</p>

                    <div id="homeMedicationsList" class="space-y-3 mb-4">
                        <!-- Medication cards will be added here -->
                    </div>

                    <button onclick="addHomeMedication()" class="w-full bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200">
                        <i class="fas fa-plus mr-2"></i> Add Home Medication
                    </button>

                    <!-- Medication input template (hidden) -->
                    <template id="medicationCardTemplate">
                        <div class="medication-card bg-gray-50 border border-gray-300 rounded-lg p-4">
                            <div class="grid grid-cols-4 gap-3 mb-2">
                                <div class="col-span-2">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Medication Name</label>
                                    <input type="text" class="med-name w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="e.g., Metformin">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Dose</label>
                                    <input type="text" class="med-dose w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="500 mg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Frequency</label>
                                    <input type="text" class="med-freq w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="BID">
                                </div>
                            </div>
                            <div class="grid grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Route</label>
                                    <select class="med-route w-full px-3 py-2 border border-gray-300 rounded text-sm">
                                        <option>PO</option>
                                        <option>IV</option>
                                        <option>IM</option>
                                        <option>SubQ</option>
                                        <option>Topical</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Indication</label>
                                    <input type="text" class="med-indication w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="e.g., Diabetes">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="removeMedicationCard(this)" class="w-full bg-red-100 text-red-700 px-3 py-2 rounded text-sm hover:bg-red-200">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Step 3: Hospital Medications -->
            <div id="step3Content" class="step-content p-6">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-900 mb-4">
                        <i class="fas fa-hospital text-indigo-600 mr-2"></i>
                        Hospital Medications
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Current hospital orders (will auto-populate from Epic when available)</p>

                    <div id="hospitalMedicationsList" class="space-y-3 mb-4">
                        <!-- Hospital medication cards -->
                    </div>

                    <button onclick="addHospitalMedication()" class="w-full bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200">
                        <i class="fas fa-plus mr-2"></i> Add Hospital Medication
                    </button>
                </div>
            </div>

            <!-- Step 4: Reconciliation Review -->
            <div id="step4Content" class="step-content p-6">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-900 mb-4">
                        <i class="fas fa-clipboard-check text-indigo-600 mr-2"></i>
                        Medication Reconciliation Summary
                    </h3>

                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-800 mb-3">Discrepancy Analysis</h4>
                        <div id="discrepanciesDisplay" class="space-y-2">
                            <!-- Will show: Added (green), Removed (red), Changed (yellow) -->
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-green-700" id="addedCount">0</div>
                            <div class="text-sm text-green-600">Medications Added</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-red-700" id="removedCount">0</div>
                            <div class="text-sm text-red-600">Medications Removed</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-yellow-700" id="changedCount">0</div>
                            <div class="text-sm text-yellow-600">Medications Changed</div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="reconciliationComplete" class="w-5 h-5 text-indigo-600 rounded mr-3">
                            <span class="text-sm font-medium text-blue-900">I have reviewed and reconciled all medications</span>
                        </label>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="printReconciliation()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-print mr-2"></i> Print Report
                        </button>
                        <button onclick="saveReconciliation()" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-save mr-2"></i> Save & Sign
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="border-t border-gray-200 p-6 flex justify-between">
                <button id="backBtn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" onclick="navigateBack()" disabled>
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <button id="nextBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" onclick="navigateNext()">
                    Next<i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button id="finishBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors hidden" onclick="finishWizard()">
                    <i class="fas fa-check mr-2"></i>Complete Setup
                </button>
            </div>
        </div>
    </main>

    <script>
        // Wizard State
        let wizardState = {
            current_step: 1,
            completed_steps: [],
            total_steps: 4,
            session_id: 'default',
            data: {}
        };

        // Medication lists
        let homeMedications = [];
        let hospitalMedications = [];

        // API Base URL
        const API_BASE = '/api/v1/wizard';

        // Initialize wizard on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Epic Integration Wizard loaded');
            await startWizard();
        });

        // Start wizard
        async function startWizard() {
            try {
                const response = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reset_existing: false })
                });

                if (!response.ok) {
                    throw new Error(`Failed to start wizard: ${response.statusText}`);
                }

                const data = await response.json();
                updateWizardUI(data);

                // Populate sandbox defaults
                populateSandboxDefaults();
            } catch (error) {
                console.log('Wizard initialization: using fallback mode');
                // Silent fallback - don't show error messages for demo
            }
        }

        // Navigate to specific step
        async function navigateToStep(stepNum) {
            // Only allow navigation to completed steps or current step + 1
            if (stepNum > wizardState.current_step + 1 && !wizardState.completed_steps.includes(stepNum)) {
                showMessage('warning', 'Please complete the current step before proceeding.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/navigate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'jump', target_step: stepNum })
                });

                if (!response.ok) {
                    throw new Error(`Navigation failed: ${response.statusText}`);
                }

                const data = await response.json();
                updateWizardUI(data);
            } catch (error) {
                console.error('Navigation error:', error);
                showMessage('error', `Navigation failed: ${error.message}`);
            }
        }

        // Navigate back
        async function navigateBack() {
            if (wizardState.current_step <= 1) return;

            try {
                const response = await fetch(`${API_BASE}/navigate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'back' })
                });

                if (!response.ok) {
                    throw new Error(`Navigation failed: ${response.statusText}`);
                }

                const data = await response.json();
                updateWizardUI(data);

                // Populate step-specific content after navigation
                handleStepSpecificLogic(data);
            } catch (error) {
                console.error('Navigation error:', error);
                showMessage('error', `Navigation failed: ${error.message}`);
            }
        }

        // Navigate next - CLIENT-SIDE MODE FOR DEMO
        function navigateNext() {
            // Validate current step before proceeding
            if (!validateCurrentStep()) {
                return;
            }

            // Collect and save current step data
            const stepData = collectCurrentStepData();
            Object.assign(wizardState.data, stepData);

            // Mark current step as completed
            if (!wizardState.completed_steps.includes(wizardState.current_step)) {
                wizardState.completed_steps.push(wizardState.current_step);
            }

            // Advance to next step
            wizardState.current_step = Math.min(wizardState.current_step + 1, 4);

            // Update UI
            updateWizardUI({
                current_step: wizardState.current_step,
                completed_steps: wizardState.completed_steps,
                total_steps: 4,
                progress_percent: Math.floor((wizardState.current_step / 4) * 100),
                step_name: 'Medication Reconciliation',
                step_description: 'Prevent medication errors during care transitions',
                can_proceed: true,
                errors: [],
                warnings: [],
                messages: [],
                state_data: wizardState.data
            });

            handleStepSpecificLogic({state_data: wizardState.data});
        }

        // Handle step-specific UI population
        function handleStepSpecificLogic(data) {
            if (wizardState.current_step === 4) {
                // Reconciliation review step - update discrepancies
                updateDiscrepancies();
            }
        }

        // Finish wizard
        async function finishWizard() {
            try {
                const response = await fetch(`${API_BASE}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`Wizard completion failed: ${response.statusText}`);
                }

                const data = await response.json();
                updateWizardUI(data);

                showMessage('success', 'Epic integration setup completed successfully!');
                updateConnectionStatus('connected', 'Connected to Epic FHIR');
            } catch (error) {
                console.error('Wizard completion error:', error);
                showMessage('error', `Failed to complete wizard: ${error.message}`);
            }
        }

        // Medication management functions
        function addHomeMedication() {
            const template = document.getElementById('medicationCardTemplate');
            const card = template.content.cloneNode(true);
            document.getElementById('homeMedicationsList').appendChild(card);
        }

        function addHospitalMedication() {
            const template = document.getElementById('medicationCardTemplate');
            const card = template.content.cloneNode(true);
            document.getElementById('hospitalMedicationsList').appendChild(card);
        }

        function removeMedicationCard(btn) {
            btn.closest('.medication-card').remove();
        }

        function collectMedications(listId) {
            const meds = [];
            const cards = document.querySelectorAll(`#${listId} .medication-card`);

            cards.forEach(card => {
                const med = {
                    name: card.querySelector('.med-name')?.value || '',
                    dose: card.querySelector('.med-dose')?.value || '',
                    frequency: card.querySelector('.med-freq')?.value || '',
                    route: card.querySelector('.med-route')?.value || '',
                    indication: card.querySelector('.med-indication')?.value || ''
                };
                if (med.name) meds.push(med);
            });

            return meds;
        }

        function updateDiscrepancies() {
            // Simple comparison - in production would use drug database
            const added = hospitalMedications.filter(h =>
                !homeMedications.some(m => m.name.toLowerCase() === h.name.toLowerCase())
            );
            const removed = homeMedications.filter(h =>
                !hospitalMedications.some(m => m.name.toLowerCase() === h.name.toLowerCase())
            );

            document.getElementById('addedCount').textContent = added.length;
            document.getElementById('removedCount').textContent = removed.length;
            document.getElementById('changedCount').textContent = 0; // Simplified

            const display = document.getElementById('discrepanciesDisplay');
            display.innerHTML = '';

            added.forEach(med => {
                display.innerHTML += `<div class="bg-green-100 border-l-4 border-green-500 p-3 rounded">
                    <span class="font-semibold text-green-800">Added:</span> ${med.name} ${med.dose} ${med.frequency}
                </div>`;
            });

            removed.forEach(med => {
                display.innerHTML += `<div class="bg-red-100 border-l-4 border-red-500 p-3 rounded">
                    <span class="font-semibold text-red-800">Removed:</span> ${med.name} ${med.dose} ${med.frequency}
                </div>`;
            });
        }

        function printReconciliation() {
            window.print();
        }

        function saveReconciliation() {
            if (!document.getElementById('reconciliationComplete')?.checked) {
                alert('Please confirm you have reviewed all medications before saving.');
                return;
            }
            alert('Medication reconciliation saved successfully!');
        }

        // Collect current step data
        function collectCurrentStepData() {
            const stepData = {};

            switch (wizardState.current_step) {
                case 1: // Patient Information
                    stepData.patient_mrn = document.getElementById('patientMrn')?.value || '';
                    stepData.patient_name = document.getElementById('patientName')?.value || '';
                    stepData.dob = document.getElementById('dob')?.value || '';
                    stepData.weight = document.getElementById('weight')?.value || '';
                    stepData.allergies = document.getElementById('allergies')?.value || '';
                    stepData.transition_type = document.getElementById('transitionType')?.value || '';
                    break;

                case 2: // Home Medications
                    homeMedications = collectMedications('homeMedicationsList');
                    stepData.home_medications = homeMedications;
                    break;

                case 3: // Hospital Medications
                    hospitalMedications = collectMedications('hospitalMedicationsList');
                    stepData.hospital_medications = hospitalMedications;
                    break;

                case 4: // Reconciliation Review
                    updateDiscrepancies();
                    stepData.reconciliation_complete = document.getElementById('reconciliationComplete')?.checked || false;
                    break;
            }

            return stepData;
        }

        // Validate current step - DISABLED FOR DEMO
        function validateCurrentStep() {
            // No validation - allow free navigation for demo purposes
            return true;
        }

        // Update wizard UI based on state
        function updateWizardUI(data) {
            wizardState = {
                current_step: data.current_step,
                completed_steps: data.completed_steps || [],
                total_steps: data.total_steps || 4,
                data: data.state_data || {}
            };

            // Update progress
            const progressPercent = data.progress_percent || 0;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressPercent').textContent = `${progressPercent}%`;
            document.getElementById('currentStepNum').textContent = data.current_step;

            // Update step indicators
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                const stepNum = index + 1;
                indicator.classList.remove('active', 'completed', 'pending');

                if (stepNum === data.current_step) {
                    indicator.classList.add('active');
                } else if (data.completed_steps.includes(stepNum)) {
                    indicator.classList.add('completed');
                } else {
                    indicator.classList.add('pending');
                }
            });

            // Show/hide step content
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === data.current_step) {
                    content.classList.add('active');
                }
            });

            // Update navigation buttons
            const backBtn = document.getElementById('backBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');

            backBtn.disabled = data.current_step === 1;

            if (data.current_step === 4) {
                nextBtn.classList.add('hidden');
                finishBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                finishBtn.classList.add('hidden');
                nextBtn.disabled = !data.can_proceed;
            }

            // Update wizard title and description
            document.getElementById('wizardTitle').textContent = data.step_name || 'Medication Reconciliation';
            document.getElementById('wizardDescription').textContent = data.step_description || '';

            // Clear any previous messages
            document.getElementById('messagesArea').innerHTML = '';

            // Show simple status message if there are any errors/warnings - don't interrupt UX
            if ((data.errors && data.errors.length > 0) || (data.warnings && data.warnings.length > 0)) {
                const statusBar = document.createElement('div');
                statusBar.className = 'text-sm text-gray-600 bg-gray-50 px-4 py-2 rounded border-l-4 border-gray-400';
                statusBar.innerHTML = `
                    <i class="fas fa-info-circle mr-2"></i>
                    <span>Due to connectivity issues, you'll need to enter configuration details manually.</span>
                `;
                document.getElementById('messagesArea').appendChild(statusBar);
            }
        }

        // Show friendly info banner for manual entry
        function showInfoBanner() {
            const messagesArea = document.getElementById('messagesArea');

            // Only show once
            if (document.getElementById('manualEntryBanner')) return;

            const banner = document.createElement('div');
            banner.id = 'manualEntryBanner';
            banner.className = 'bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg mb-4';
            banner.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-600 mr-3 mt-0.5"></i>
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-blue-900 mb-1">Manual Entry Mode</p>
                        <p class="text-sm text-blue-800">Unable to auto-detect configuration. You'll need to enter your Epic FHIR credentials manually in the next steps. This is normal if you're setting up for the first time or don't have connectivity to Epic services yet.</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-blue-600 hover:text-blue-800 flex-shrink-0">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            messagesArea.appendChild(banner);
        }

        // Show message (improved with collapsible details)
        function showMessage(type, text) {
            const messagesArea = document.getElementById('messagesArea');
            const messageClass = `message-${type}`;
            const icon = type === 'error' ? 'fa-times-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-check-circle';

            // Simplify long technical error messages
            let displayText = text;
            let detailsText = '';
            let isCollapsible = false;

            // Check if this is a long configuration error
            if (text.includes('validation errors for Settings') || text.length > 200) {
                isCollapsible = true;

                // Extract summary
                if (text.includes('Prerequisites missing')) {
                    displayText = 'Configuration check: Some prerequisites are missing (click to see details)';
                    detailsText = text;
                } else if (text.includes('validation errors')) {
                    displayText = 'Configuration validation issues detected (click to see details)';
                    detailsText = text;
                } else if (text.length > 200) {
                    displayText = text.substring(0, 150) + '... (click to see full message)';
                    detailsText = text;
                }
            }

            const messageId = `msg-${Date.now()}`;
            const messageDiv = document.createElement('div');
            messageDiv.className = `${messageClass} p-4 rounded-lg mb-2`;
            messageDiv.innerHTML = `
                <div class="flex items-start">
                    <i class="fas ${icon} mr-3 mt-0.5"></i>
                    <div class="flex-1">
                        <span class="cursor-pointer" onclick="toggleMessageDetails('${messageId}')">${displayText}</span>
                        ${isCollapsible ? `
                            <div id="${messageId}" class="hidden mt-2 p-3 bg-black bg-opacity-5 rounded text-xs font-mono whitespace-pre-wrap max-h-48 overflow-y-auto">
                                ${detailsText}
                            </div>
                        ` : ''}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-600 hover:text-gray-800 flex-shrink-0">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            messagesArea.appendChild(messageDiv);

            // Auto-remove success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => messageDiv.remove(), 5000);
            }
        }

        // Toggle message details
        function toggleMessageDetails(id) {
            const details = document.getElementById(id);
            if (details) {
                details.classList.toggle('hidden');
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(status, text) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusIndicator');

            statusIndicator.className = `connection-status ${status}`;
            statusText.textContent = text;
        }
    
        // ===== PERSISTENCE FUNCTIONS =====

        const WIZARD_ID = 'medication-reconciliation-wizard';

        // Check for saved draft on page load
        window.addEventListener('DOMContentLoaded', () => {
            if (WizardPersistence.hasSavedDraft(WIZARD_ID)) {
                WizardPersistence.showResumeDraftModal(
                    WIZARD_ID,
                    () => resumeDraft(),
                    () => console.log('Starting fresh')
                );
            }
            // Initialize care setting framework
            CareSettings.init({
                showOnboardingIfNew: false,
                injectBadge: true,
                headerSelector: 'header'
            });

        });

        // Auto-save on next step
        const originalNextStep = nextStep;
        function nextStep() {
            autosaveDraft();
            originalNextStep();
        }

        // Auto-save draft
        function autosaveDraft() {
            const formData = {};
            const currentStepNum = parseInt(document.querySelector('.step.active')?.dataset.step || '1');

            // Collect data from all steps
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                const stepData = {};

                step.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.id) {
                        if (input.type === 'checkbox') {
                            stepData[input.id] = input.checked;
                        } else if (input.type === 'radio') {
                            if (input.checked) {
                                stepData[input.name] = input.value;
                            }
                        } else {
                            stepData[input.id] = input.value;
                        }
                    }
                });

                if (Object.keys(stepData).length > 0) {
                    formData[`step${stepNum}`] = stepData;
                }
            });

            WizardPersistence.saveWizardState(WIZARD_ID, currentStepNum, formData);

            // Show save button
            const saveBtn = document.getElementById('saveDraftBtn');
            if (saveBtn && currentStepNum > 1) {
                saveBtn.style.display = 'inline-block';
            }
        }

        // Manual save
        function saveDraft() {
            autosaveDraft();
            alert('Draft saved successfully!');
        }

        // Resume draft
        function resumeDraft() {
            const savedState = WizardPersistence.loadWizardState(WIZARD_ID);
            if (!savedState) return;

            // Restore to saved step
            const targetStep = savedState.currentStep;

            // Restore form data
            if (savedState.formData) {
                Object.keys(savedState.formData).forEach(stepKey => {
                    const stepData = savedState.formData[stepKey];
                    Object.keys(stepData).forEach(fieldId => {
                        const input = document.getElementById(fieldId);
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = stepData[fieldId];
                            } else if (input.type === 'radio') {
                                const radio = document.querySelector(`input[name="${fieldId}"][value="${stepData[fieldId]}"]`);
                                if (radio) radio.checked = true;
                            } else {
                                input.value = stepData[fieldId];
                            }
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                });
            }

            // Navigate to saved step
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active');
                if (i + 1 === targetStep) {
                    s.classList.add('active');
                }
                if (i + 1 < targetStep) {
                    document.querySelector(`[data-step="${i+1}"]`)?.classList.add('completed');
                }
            });

            currentStep = targetStep;
            updateProgress();

            const lastSave = WizardPersistence.getLastSaveTime(WIZARD_ID);
            alert(`Draft restored from ${lastSave}`);
        }

        // Clear draft on completion
        const originalCompleteWizard = window.completeWizard || function() {};
        window.completeWizard = function() {
            WizardPersistence.clearWizardState(WIZARD_ID);
            originalCompleteWizard();
        };

    </script>
</body>
</html>
